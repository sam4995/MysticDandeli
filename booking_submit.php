<?php require __DIR__.'/config.php'; require __DIR__.'/db.php'; if(session_status()!==PHP_SESSION_ACTIVE) session_start(); if(!csrf_check($_POST['csrf']??'')) die('Invalid request'); if(!empty($_POST['website'])) die('Spam detected'); $type=$_POST['type']??'activity'; $ref=(int)($_POST['ref_id']??0); $people=max(1,(int)($_POST['people']??1)); $name=trim($_POST['name']??''); $email=trim($_POST['email']??''); $phone=trim($_POST['phone']??''); $notes=trim($_POST['notes']??''); $checkin=$_POST['checkin']??null; $checkout=$_POST['checkout']??null; $activity_date=$_POST['activity_date']??null; if(!filter_var($email,FILTER_VALIDATE_EMAIL)) die('Invalid email'); if(!preg_match('/^[0-9+\-\s]{8,15}$/',$phone)) die('Invalid phone'); if(!in_array($type,['activity','resort'])) die('Invalid type'); $db=db(); $stmt=$db->prepare("INSERT INTO bookings (type,ref_id,checkin,checkout,activity_date,people,name,email,phone,notes) VALUES (?,?,?,?,?,?,?,?,?,?)"); $stmt->execute([$type,$ref,$checkin,$checkout,$activity_date,$people,$name,$email,$phone,$notes]); $bid=$db->lastInsertId(); function notify($to,$subj,$html,$text){ require __DIR__.'/config.php'; if(USE_PHPMAILER){ require __DIR__.'/vendor/autoload.php'; $mail=new PHPMailer\PHPMailer\PHPMailer(true); try{$mail->isSMTP();$mail->Host=$SMTP['host'];$mail->Port=$SMTP['port'];$mail->SMTPAuth=true;$mail->Username=$SMTP['username'];$mail->Password=$SMTP['password']; if($SMTP['secure']==='tls')$mail->SMTPSecure=PHPMailer\PHPMailer\PHPMailer::ENCRYPTION_STARTTLS; $mail->setFrom($SMTP['from_email'],$SMTP['from_name']); $mail->addAddress($to); $mail->isHTML(true); $mail->Subject=$subj; $mail->Body=$html; $mail->AltBody=$text; $mail->send(); }catch(Exception $e){} } else { @mail($to,$subj,$text,"From: no-reply@".$_SERVER['HTTP_HOST']); } } $summary="Thanks $name,

Your request (#$bid) has been received. We’ll confirm availability by email/phone.

Regards,
$SITE_NAME"; notify($email,"Booking request received (#$bid)",nl2br($summary),$summary); if(!empty($ADMIN_EMAIL)) notify($ADMIN_EMAIL,"New booking #$bid",$summary,$summary); ?>
<!doctype html><html lang='en'><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'><link href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css' rel='stylesheet'><title>Booking Submitted</title></head><body class='container py-5'><h1>Booking submitted</h1><p>Thank you! Your request ID is <strong>#<?= (int)$bid ?></strong>. We’ll contact you shortly.</p><a class='btn btn-brand' href='index.php'>Back to Home</a></body></html>